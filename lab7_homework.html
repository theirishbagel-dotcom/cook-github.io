<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Census Housing Query Web Map</title>

  <!-- ArcGIS CSS for styling the map and widgets -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css"/>

  <!-- ArcGIS JS API for working with maps, layers, and queries -->
  <script src="https://js.arcgis.com/4.21/"></script>

  <style>
    /* Set the map to take up the full page */
    html, body, #viewDiv {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Controls container at the top-left corner of the map */
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 10;
      width: 220px;
    }

    /* Options container at the bottom-right corner for query inputs */
    #optionsDiv {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 10;
    }

    /* Footer centered at the bottom of the map */
    #footer {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%); /* Centers the footer horizontally */
      background-color: rgba(255,255,255,0.8); /* Semi-transparent background */
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- Top-left controls for navigation to other map pages -->
<div id="controls">
  <h3>U.S. Housing Details by Census Tract</h3>
  <div id="navMenu">
    <label for="pageSelect">Open another map:</label>
    <select id="pageSelect" onchange="if(this.value) window.open(this.value,'_blank')">
      <option value="">Select a page</option>
      <option value="tile_layer.html">Tile Layer</option>
      <option value="simple_mapping.html">Simple Mapping</option>
      <option value="query_task.html">Query Task</option>
      <option value="on_event.html">On Event</option>
      <option value="dynamic_layers.html">Dynamic Layers</option>
      <option value="basemap_gallery.html">Basemap Gallery</option>
    </select>
  </div>
</div>

<!-- Bottom-right controls for building queries -->
<div id="optionsDiv">
  <!-- Dropdown to select which attribute to query -->
  <label for="attSelect">Attribute:</label>
  <select id="attSelect">
    <option value="HUs_percent_before_1940">Percent Housing Units Built 1939 or Earlier</option>
    <option value="ACSMEDYBLT">ACS Median Year Structure Built (HUs)</option>
  </select>
  <br><br>

  <!-- Dropdown to select the operator for comparison -->
  <label for="signSelect">Operator:</label>
  <select id="signSelect">
    <option value="&gt;">is greater than</option>
    <option value="&lt;">is less than</option>
    <option value="=">is equal to</option>
  </select>
  <br><br>

  <!-- Input for the value to compare against -->
  <label for="valSelect">Value:</label>
  <input type="number" id="valSelect" value="50">
  <br><br>

  <!-- Button to run the query -->
  <button id="doBtn">Run Query</button>

  <!-- Paragraph to print the number of results found -->
  <p id="printResults"></p>
</div>

<!-- The div that will contain the ArcGIS map -->
<div id="viewDiv"></div>

<!-- Footer with credit and data source -->
<div id="footer">&copy; 2025 Parker Cook | Data source: ESRI Census Housing Year Built</div>

<script>
require([
  // Load required ArcGIS modules
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/layers/GraphicsLayer",
  "esri/tasks/QueryTask",
  "esri/tasks/support/Query",
  "dojo/dom",
  "dojo/on",
  "dojo/_base/array"
], function(Map, MapView, FeatureLayer, GraphicsLayer, QueryTask, Query, dom, on, arrayUtils){

  // 1. Create the map with a base map style
  const map = new Map({
    basemap: "streets-navigation-vector"
  });

  // 2. Create the view (map display), centered on the continental US
  const view = new MapView({
    container: "viewDiv", // Div to display map
    map: map,
    center: [-98.5795, 39.8283], // Longitude, latitude of US center
    zoom: 4.5 // Zoom level to show most of the US
  });

  // 3. URL to the census housing FeatureLayer
  const layerUrl = "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/Census_Tracts_Housing_Year_Built/FeatureServer/0";

  // 4. Create a FeatureLayer for the census tracts
  const censusLayer = new FeatureLayer({
    url: layerUrl,
    outFields: ["*"], // Pull all attributes
    popupTemplate: { // Configure popup to display info when clicked
      title: "Census Tract Info",
      content: `<b>Percent Housing Units Built 1939 or Earlier:</b> {HUs_percent_before_1940}<br>
          <b>ACS Median Year Structure Built (HUs):</b> {ACSMEDYBLT}`
    }
  });
  map.add(censusLayer); // Add the census layer to the map

  // 5. Create a GraphicsLayer to display query results
  const resultsLayer = new GraphicsLayer();
  map.add(resultsLayer);

  // 6. Set up a QueryTask for querying the FeatureLayer
  const qTask = new QueryTask({ url: layerUrl });

  // Query parameters: return geometry (to display on map) and all attributes
  const qParams = new Query({
    returnGeometry: true,
    outFields: ["*"]
  });

  // 7. Function to run the query based on user input
  function doQuery(){
    // Clear any previous query results
    resultsLayer.removeAll();

    // Get values from the dropdowns and input
    const attribute = dom.byId("attSelect").value; // e.g., HUs_percent_before_1940
    const operator = dom.byId("signSelect").value; // e.g., >
    const value = dom.byId("valSelect").value; // e.g., 50

    // Build the SQL "where" clause for the query
    qParams.where = `${attribute} ${operator} ${value}`;

    // Execute the query
    qTask.execute(qParams).then(function(res){
      // If no results found, print a message
      if(res.features.length === 0){
        dom.byId("printResults").innerHTML = "No results found!";
        return;
      }

      // Assign popupTemplate to each feature so popup works on results
      arrayUtils.forEach(res.features, function(f){
        f.popupTemplate = censusLayer.popupTemplate;
      });

      // Add the results to the map
      resultsLayer.addMany(res.features);

      // Zoom to the query results and open the popup
      view.goTo(res.features).then(function(){
        view.popup.open({ features: res.features });
      });

      // Display how many results were found
      dom.byId("printResults").innerHTML = res.features.length + " results found!";
    }).catch(err => console.error("Query failed:", err)); // Log errors if query fails
  }

  // 8. Attach the query function to the button click
  on(dom.byId("doBtn"), "click", doQuery);

});
</script>

</body>
</html>
</html>
